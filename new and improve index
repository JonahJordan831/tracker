<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BerryIMU 3D Viewer</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: #eee;
      font-family: Arial, sans-serif;
      overflow: hidden;
      padding: 20px;
      border: 15px solid;
      border-image: linear-gradient(135deg, #64b3f4, #c2e59c) 1;
      box-sizing: border-box;
      height: 100vh;
    }
    #ui {
      position: absolute;
      top: 30px;
      left: 30px;
      z-index: 10;
      background: rgba(0,0,0,0.6);
      padding: 10px;
      border-radius: 4px;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }
    #status {
      margin-top: 8px;
      font-size: 13px;
    }
    #angles {
      position: absolute;
      bottom: 30px;
      left: 30px;
      z-index: 10;
      background: rgba(0,0,0,0.6);
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
    }
    #label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -280px);
      z-index: 5;
      font-size: 28px;
      font-weight: bold;
      color: #00ff00;
      text-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
      letter-spacing: 3px;
    }
    #tapIndicator {
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      background: rgba(0,0,0,0.6);
      padding: 10px 15px;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      color: #ff4444;
      display: none;
    }
  </style>
</head>
<body>
  <div id="ui">
    <button id="connectBtn">Connect to IMU</button>
    <div id="status">Status: Disconnected</div>
  </div>
  <div id="angles">R: 0.00° P: 0.00° Y: 0.00°</div>
  <div id="label">WEAPON POSITION</div>
  <div id="tapIndicator">SHOTS FIRED!</div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    let scene, camera, renderer, weaponModel, fallbackBox;
    const statusEl = document.getElementById("status");
    const anglesEl = document.getElementById("angles");
    const tapIndicator = document.getElementById("tapIndicator");
    let normalMaterial, redMaterial;
    let tapTimeout = null;

    function initThree() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x111111);

      const width = window.innerWidth - 40;
      const height = window.innerHeight - 40;

      camera = new THREE.PerspectiveCamera(50, width / height, 0.1, 1000);
      camera.position.set(3, 3, 6);
      camera.lookAt(0, 0, 0);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(width, height);
      document.body.appendChild(renderer.domElement);

      // Add lights
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
      directionalLight.position.set(5, 10, 5);
      scene.add(directionalLight);

      // Gray wireframe sphere
      const sphereGeom = new THREE.SphereGeometry(2.1, 24, 24);
      const sphereMat = new THREE.MeshBasicMaterial({
        color: 0x777777,
        wireframe: true,
        opacity: 0.5,
        transparent: true
      });
      const sphere = new THREE.Mesh(sphereGeom, sphereMat);
      scene.add(sphere);

      // Create materials for tap effect
      normalMaterial = new THREE.MeshStandardMaterial({
        color: 0x4488ff,
        metalness: 0.3,
        roughness: 0.5,
        emissive: 0x2244aa,
        emissiveIntensity: 0.3
      });

      redMaterial = new THREE.MeshStandardMaterial({
        color: 0xff0000,
        metalness: 0.3,
        roughness: 0.5,
        emissive: 0xff0000,
        emissiveIntensity: 0.5
      });

      // Create fallback box
      const geometry = new THREE.BoxGeometry(2.5, 0.4, 1.0);
      fallbackBox = new THREE.Mesh(geometry, normalMaterial.clone());
      scene.add(fallbackBox);
      weaponModel = fallbackBox;

      // Load M16 rifle model
      const loader = new GLTFLoader();
      
      loader.load(
        'low-poly_m16.glb',
        function(gltf) {
          weaponModel = gltf.scene;
          
          weaponModel.scale.set(0.02, 0.02, 0.02);
          weaponModel.position.set(0, 0, 0);
          
          // Apply blue material to all meshes
          weaponModel.traverse(function(child) {
            if (child.isMesh) {
              child.material = normalMaterial.clone();
              child.userData.originalMaterial = child.material;
            }
          });
          
          scene.add(weaponModel);
          fallbackBox.visible = false;
          statusEl.textContent += " | M16 loaded";
        },
        undefined,
        function(error) {
          console.error('M16 load error:', error);
          statusEl.textContent += " | Using box";
        }
      );

      window.addEventListener("resize", onWindowResize);
      animate();
    }

    function onWindowResize() {
      const width = window.innerWidth - 40;
      const height = window.innerHeight - 40;
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
      renderer.setSize(width, height);
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }

    function setOrientation(roll, pitch, yaw, tap) {
      if (weaponModel) {
        weaponModel.rotation.order = "ZYX";
        weaponModel.rotation.z = THREE.MathUtils.degToRad(roll);
        weaponModel.rotation.y = THREE.MathUtils.degToRad(yaw);
        weaponModel.rotation.x = THREE.MathUtils.degToRad(pitch);

        // Handle tap detection
        if (tap === 1) {
          // Turn M16 red
          weaponModel.traverse(function(child) {
            if (child.isMesh) {
              child.material = redMaterial.clone();
            }
          });

          // Show tap indicator
          tapIndicator.style.display = 'block';

          // Clear any existing timeout
          if (tapTimeout) clearTimeout(tapTimeout);

          // Reset to blue after 500ms
          tapTimeout = setTimeout(() => {
            weaponModel.traverse(function(child) {
              if (child.isMesh) {
                child.material = normalMaterial.clone();
              }
            });
            tapIndicator.style.display = 'none';
          }, 500);
        }
      }

      anglesEl.textContent = `R: ${roll.toFixed(2)}° P: ${pitch.toFixed(2)}° Y: ${yaw.toFixed(2)}°`;
    }

    async function connectSerial() {
      let port;
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        statusEl.textContent = "Status: Connected. Reading data...";

        const textDecoder = new TextDecoderStream();
        const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
        const reader = textDecoder.readable.getReader();

        let buffer = "";
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += value;

          let lines = buffer.split("\n");
          buffer = lines.pop();

          for (let line of lines) {
            line = line.trim();
            if (!line) continue;
            // Skip debug lines that start with ***
            if (line.startsWith("***")) continue;
            
            const parts = line.split(",");
            if (parts.length !== 4) continue;
            const roll = parseFloat(parts[0]);
            const pitch = parseFloat(parts[1]);
            const yaw = parseFloat(parts[2]);
            const tap = parseInt(parts[3]);
            if (Number.isNaN(roll) || Number.isNaN(pitch) || Number.isNaN(yaw)) {
              continue;
            }
            setOrientation(roll, pitch, yaw, tap);
          }
        }

        await reader.releaseLock();
        await readableStreamClosed;
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Status: Error - " + err;
      } finally {
        if (port) {
          try { await port.close(); } catch {}
        }
        statusEl.textContent = "Status: Disconnected";
      }
    }

    document.getElementById("connectBtn").addEventListener("click", () => {
      connectSerial();
    });

    initThree();
  </script>
</body>
</html>
